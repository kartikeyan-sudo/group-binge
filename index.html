<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Together: Modern P2P YouTube Sync (No PeerJS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Simple-Peer -->
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    :root {
      --bg-dark: #1d1333;
      --bg-dark2: #271a45;
      --purple: #7c3aed;
      --purple-light: #a78bfa;
      --text-main: #ede9fe;
      --text-soft: #b5b3c8;
      --surface: #25204a;
      --accent: #facc15;
    }
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: var(--bg-dark);
      color: var(--text-main);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    header {
      padding: 1em 0.5em;
      text-align: center;
      background: var(--bg-dark2);
      box-shadow: 0 2px 12px #0002;
      font-size: 1.4em;
      font-weight: bold;
      letter-spacing: 1px;
      color: var(--purple-light);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-height: 0;
      overflow: hidden;
    }
    .side {
      background: var(--surface);
      flex: 1.1 1 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 1em 0.5em;
      box-sizing: border-box;
      min-width: 0;
      gap: 1em;
      border-right: 2px solid var(--bg-dark2);
    }
    .center {
      flex: 2 1 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 1em 0.5em;
      min-width: 0;
      gap: 1em;
    }
    .input-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
      justify-content: flex-start;
      background: var(--bg-dark2);
      border-radius: 9px;
      padding: 0.5em 0.8em;
    }
    .input-row label {
      font-weight: 500;
      color: var(--purple-light);
    }
    input, button {
      background: var(--bg-dark);
      color: var(--text-main);
      border: 1.5px solid var(--purple);
      border-radius: 7px;
      padding: 0.38em 0.9em;
      font-size: 1em;
      outline: none;
      margin: 0;
      transition: border .2s;
    }
    input:focus, button:focus {
      border-color: var(--accent);
    }
    button {
      cursor: pointer;
      background: var(--purple);
      color: #fff;
      border: none;
      font-weight: 500;
      transition: background .2s;
    }
    button:hover {
      background: var(--accent);
      color: var(--bg-dark);
    }
    #status {
      text-align: left;
      font-size: 1em;
      color: var(--accent);
      margin: 0.5em 0;
      min-height: 1.5em;
    }
    .peers-list {
      display: flex;
      flex-direction: column;
      gap: 1.2em;
      margin-top: 1em;
    }
    .peer-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: var(--bg-dark2);
      padding: 0.6em 1em 1em 1em;
      border-radius: 12px;
      box-shadow: 0 2px 4px #0001;
      gap: 0.4em;
      min-width: 0;
      position: relative;
    }
    .peer-label {
      font-size: 1.05em;
      color: var(--purple-light);
      font-weight: 500;
      margin-bottom: 0.3em;
    }
    .video-wrap {
      width: 100%;
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-wrap video {
      width: 100%;
      max-width: 250px;
      aspect-ratio: 3/2;
      background: #000;
      border-radius: 8px;
      transition: filter .15s;
    }
    .controls {
      margin-top: 0.4em;
      display: flex;
      gap: 0.8em;
      align-items: center;
    }
    .ctrl-btn {
      background: var(--surface);
      border: 1.5px solid var(--purple-light);
      color: var(--purple-light);
      border-radius: 50%;
      width: 2.1em;
      height: 2.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.13em;
      cursor: pointer;
      transition: background .2s, color .2s, border .2s;
    }
    .ctrl-btn.active, .ctrl-btn:active {
      background: var(--purple);
      color: #fff;
      border-color: var(--accent);
    }
    /* YouTube player area */
    .yt-area {
      background: var(--bg-dark2);
      border-radius: 14px;
      padding: 1em;
      margin-top: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 3px 9px #0002;
    }
    #ytplayer {
      width: 100%;
      max-width: 540px;
      min-height: 200px;
      aspect-ratio: 16 / 9;
      background: #181029;
      border-radius: 12px;
      margin-bottom: 0.6em;
    }
    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      .side, .center {
        flex: unset;
        min-width: 0;
        width: 100%;
        border-right: none;
      }
      .yt-area {
        margin-top: 1em;
      }
    }
    @media (max-width: 600px) {
      .video-wrap video {
        max-width: 100vw;
      }
      .yt-area {
        padding: 0.3em;
      }
      .input-row {
        flex-direction: column;
        align-items: stretch;
        gap: 0.3em;
        padding: 0.35em 0.3em;
      }
    }
  </style>
</head>
<body>
  <header>
    <span>ðŸŽ¬ Watch Together</span>
    <span style="font-size:0.7em;font-weight:400;color:var(--text-soft);margin-left:.6em;">(P2P, YouTube Sync, Dark Purple)</span>
  </header>
  <main>
    <div class="side">
      <div class="input-row">
        <label>Room ID:</label>
        <input id="roomid" autocomplete="off" placeholder="Type a room name" />
        <button onclick="createOrJoin()">Join</button>
      </div>
      <div class="peers-list">
        <div class="peer-card" id="my-card">
          <span class="peer-label">You</span>
          <div class="video-wrap">
            <video id="myvideo" autoplay playsinline muted></video>
          </div>
          <div class="controls">
            <button class="ctrl-btn" id="my-audio" title="Toggle Audio">
              <span id="my-audio-ico">ðŸ”‡</span>
            </button>
            <button class="ctrl-btn active" id="my-video" title="Toggle Video">
              <span id="my-video-ico">ðŸŽ¥</span>
            </button>
          </div>
        </div>
        <div class="peer-card" id="peer-card" style="display:none;">
          <span class="peer-label">Peer</span>
          <div class="video-wrap">
            <video id="peervideo" autoplay playsinline></video>
          </div>
          <div class="controls">
            <button class="ctrl-btn" id="peer-audio" title="Toggle Peer Audio">
              <span id="peer-audio-ico">ðŸ”‡</span>
            </button>
            <button class="ctrl-btn active" id="peer-video" title="Toggle Peer Video">
              <span id="peer-video-ico">ðŸŽ¥</span>
            </button>
          </div>
        </div>
      </div>
      <div id="status"></div>
    </div>
    <div class="center">
      <div class="input-row">
        <label>YouTube Link:</label>
        <input id="ytlink" autocomplete="off" placeholder="Paste YouTube URL here" />
        <button onclick="setYT()">Set Video</button>
      </div>
      <div class="yt-area">
        <div id="ytplayer"></div>
      </div>
    </div>
  </main>
  <script>
    // --- SIGNALING via public websocket echo server (demo only!) ---
    // In production, run your own server!
    const SIGNAL_SERVER = "wss://ws.postman-echo.com/raw";
    let ws;
    let isInitiator = false, connected = false, peer, remoteAudio = true, remoteVideo = true;
    let localStream, roomid = '', ytPlayer, isYTReady = false;

    function setStatus(msg) {
      document.getElementById('status').textContent = 'Status: ' + msg;
    }

    // Get local video/audio
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      document.getElementById('myvideo').srcObject = stream;
    }).catch(() => {
      setStatus("Camera/Mic access denied");
    });

    function createOrJoin() {
      if (connected) return;
      roomid = document.getElementById('roomid').value.trim();
      if (!roomid) return alert('Enter a Room ID!');
      ws = new WebSocket(SIGNAL_SERVER);
      ws.onopen = () => {
        setStatus('Connected to signaling server');
        ws.send(JSON.stringify({ room: roomid, type: 'join' }));
      };
      ws.onmessage = (msg) => {
        handleSignal(JSON.parse(msg.data));
      };
    }
    function sendSignal(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        data.room = roomid;
        ws.send(JSON.stringify(data));
      }
    }
    function handleSignal(data) {
      if (data.type === 'join' && !peer) {
        isInitiator = true;
        startPeer();
      } else if (data.type === 'signal' && peer) {
        peer.signal(data.signal);
      } else if (data.type === 'signal' && !peer) {
        startPeer(false, data.signal);
      }
    }
    function startPeer(initiator = isInitiator, incomingSignal = null) {
      peer = new SimplePeer({
        initiator: initiator,
        stream: localStream,
        trickle: false
      });
      peer.on('signal', signal => {
        sendSignal({ type: 'signal', signal });
      });
      peer.on('connect', () => {
        setStatus('P2P Connected!');
        connected = true;
        document.getElementById('peer-card').style.display = '';
      });
      peer.on('stream', stream => {
        document.getElementById('peervideo').srcObject = stream;
        document.getElementById('peer-card').style.display = '';
      });
      peer.on('data', data => {
        let msg = JSON.parse(data.toString());
        if (msg.type === 'yt') loadYT(msg.videoId);
        if (msg.type === 'yt-control' && isYTReady) {
          if (msg.action === 'play') ytPlayer.playVideo();
          if (msg.action === 'pause') ytPlayer.pauseVideo();
          if (msg.action === 'seek') ytPlayer.seekTo(msg.time, true);
        }
        if (msg.type === 'peer-controls') {
          if ('audio' in msg) remoteAudio = msg.audio;
          if ('video' in msg) remoteVideo = msg.video;
          document.getElementById('peervideo').muted = !remoteAudio;
          document.getElementById('peer-audio').classList.toggle('active', remoteAudio);
          document.getElementById('peer-audio-ico').textContent = remoteAudio ? 'ðŸ”Š' : 'ðŸ”‡';
          document.getElementById('peervideo').style.filter = remoteVideo ? '' : 'brightness(0.2) grayscale(1)';
          document.getElementById('peer-video').classList.toggle('active', remoteVideo);
          document.getElementById('peer-video-ico').textContent = remoteVideo ? 'ðŸŽ¥' : 'ðŸ“·';
        }
      });
      if (incomingSignal) peer.signal(incomingSignal);
    }

    // Local controls
    let myAudio = true, myVideo = true;
    document.getElementById('my-audio').onclick = () => {
      myAudio = !myAudio;
      localStream.getAudioTracks().forEach(t => t.enabled = myAudio);
      document.getElementById('my-audio').classList.toggle('active', myAudio);
      document.getElementById('my-audio-ico').textContent = myAudio ? 'ðŸ”Š' : 'ðŸ”‡';
      sendPeerControl();
    };
    document.getElementById('my-video').onclick = () => {
      myVideo = !myVideo;
      localStream.getVideoTracks().forEach(t => t.enabled = myVideo);
      document.getElementById('my-video').classList.toggle('active', myVideo);
      document.getElementById('my-video-ico').textContent = myVideo ? 'ðŸŽ¥' : 'ðŸ“·';
      document.getElementById('myvideo').style.filter = myVideo ? '' : 'brightness(0.2) grayscale(1)';
      sendPeerControl();
    };
    // Peer controls - just toggles mute/view locally
    document.getElementById('peer-audio').onclick = () => {
      remoteAudio = !remoteAudio;
      document.getElementById('peervideo').muted = !remoteAudio;
      document.getElementById('peer-audio').classList.toggle('active', remoteAudio);
      document.getElementById('peer-audio-ico').textContent = remoteAudio ? 'ðŸ”Š' : 'ðŸ”‡';
    };
    document.getElementById('peer-video').onclick = () => {
      remoteVideo = !remoteVideo;
      document.getElementById('peervideo').style.filter = remoteVideo ? '' : 'brightness(0.2) grayscale(1)';
      document.getElementById('peer-video').classList.toggle('active', remoteVideo);
      document.getElementById('peer-video-ico').textContent = remoteVideo ? 'ðŸŽ¥' : 'ðŸ“·';
    };
    function sendPeerControl() {
      if (peer && peer.connected) {
        peer.send(JSON.stringify({type: 'peer-controls', audio: myAudio, video: myVideo}));
      }
    }

    // --- YOUTUBE PLAYER ---
    // Load YouTube IFrame API
    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      ytPlayer = new YT.Player('ytplayer', {
        height: '315', width: '560', videoId: '',
        playerVars: { 'rel': 0, 'modestbranding': 1 },
        events: {
          'onReady': () => { isYTReady = true; },
          'onStateChange': onYTState
        }
      });
    }

    function setYT() {
      let url = document.getElementById('ytlink').value.trim();
      let videoId = parseYT(url);
      if (!videoId) return alert('Invalid YouTube Link!');
      loadYT(videoId);
      if (peer && peer.connected) peer.send(JSON.stringify({type: 'yt', videoId}));
    }
    function parseYT(url) {
      let match = url.match(/(?:youtu\.be\/|youtube\.com.*(?:v=|\/embed\/|\/shorts\/))([\w-]{11})/);
      return match ? match[1] : null;
    }
    function loadYT(videoId) {
      if (isYTReady) ytPlayer.loadVideoById(videoId);
      else {
        let intv = setInterval(() => {
          if (isYTReady) {
            ytPlayer.loadVideoById(videoId);
            clearInterval(intv);
          }
        }, 300);
      }
    }
    // Sync control (play/pause/seek)
    let lastActionTime = 0;
    function onYTState(event) {
      if (!peer || !peer.connected) return;
      let action = event.data === 1 ? 'play' : event.data === 2 ? 'pause' : null;
      if (action) {
        let now = Date.now();
        if (now - lastActionTime < 500) return;
        peer.send(JSON.stringify({type: 'yt-control', action}));
        lastActionTime = now;
      }
      if (event.data === 1 || event.data === 2) {
        try {
          let time = ytPlayer.getCurrentTime();
          peer.send(JSON.stringify({type: 'yt-control', action: 'seek', time}));
        } catch (e) {}
      }
    }
  </script>
</body>
</html>
